<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>艦これ自然回復＆遠征資源計算機</title>
<script type="text/javascript">
<!--

// args :: void
// return .self :: function
// description 定期的に現在時刻表示関数(showNowTime)を呼び出す関数
function clockTimer(){
	setInterval(showNowTime,1000)
}

// args time :: Object[year,mon,date,hour,min,sec]
// return :: String
// description Dateを人間の読みやすい形式に変換する（日本語）
function toReadableTime(time){
	rtn = time.year+'年'+time.mon+'月'+time.date+'日'+time.hour+'時'+time.min+'分'+time.sec+'秒';
	return rtn;
}

// args :: void
// return .self :: function
// description 
function showNowTime(){
	now = getNowTimeObj();
	nowstr = '現在時刻：'+toReadableTime(now);

	document.getElementById('timenow').innerHTML = nowstr;
}

// args :: void
// return :: Object[year,mon,date,hour,min,sec]
// description 現在時刻を連想配列として返す
function getNowTimeObj(){
	now = new Date();
	rtn = new Object();

	rtn.year = now.getFullYear().toString();
	rtn.mon  = ('00'+(now.getMonth()+1).toString()).slice(-2);
	rtn.date = ('00'+now.getDate().toString()).slice(-2);
	rtn.hour = ('00'+now.getHours().toString()).slice(-2);
	rtn.min  = ('00'+now.getMinutes().toString()).slice(-2);
	rtn.sec  = ('00'+now.getSeconds().toString()).slice(-2);
	return rtn
}

// args type :: String
// return (.self :: function) | :: Bool
// description typeで指定された値('start','end')に従い、開始時刻あるいは予定時刻の入力値を現在時刻に設定する。引数不正の場合、falseを返す。
function setInputTimeNow(type){
	now = getNowTimeObj();
	nowstr = now.year+'-'+now.mon+'-'+now.date+'T'+now.hour+':'+now.min;

	if(type==='start'){
		document.getElementsByName('starttime')[0].value = nowstr;
	}else if(type==='end'){
		document.getElementsByName('endtime')[0].value = nowstr;
	}else{
		return false;
	}
}

// args type :: String
// return :: Date | Bool
// description typeに指定された値('start','end')に従い、開始時刻あるいは予定時刻の入力値をDate型で返す。引数不正の場合、falseを返す
function getInputTime(type){
	if(type==='start'){
		timestr = document.getElementsByName('starttime')[0].value;
	}else if(type==='end'){
		timestr = document.getElementsByName('endtime')[0].value;
	}else{
		return false;
	}
	parsed = (/(^\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/).exec(timestr);
	
	year = parseInt(parsed[1]);
	mon  = parseInt(parsed[2]) - 1;
	date = parseInt(parsed[3]);
	hour = parseInt(parsed[4]);
	min  = parseInt(parsed[5]);

	rtn = new Date(year,mon,date,hour,min);

	return rtn;
}

// args mats :: Object[fuel,ammo,steel,bauxite]
// return .self :: function
// description matsで指定された資材を表示する関数
function setMaterials(mats){
	fuel    = document.getElementsByName('fuel')[0];
	ammo    = document.getElementsByName('ammo')[0];
	steel   = document.getElementsByName('steel')[0];
	bauxite = document.getElementsByName('bauxite')[0];

	fuel.value    = mats.fuel;
	ammo.value    = mats.ammo;
	steel.value   = mats.steel;
	bauxite.value = mats.bauxite;
}

// args :: void
// return :: Object[furl,ammo,steel,bauxite]
// description 入力欄に入っているそれぞれの資材の量を連想配列として返す関数
function getMaterials(){
	rtn = new Object;

	rtn.fuel    = parseInt(document.getElementsByName('fuel')[0].value);
	rtn.ammo    = parseInt(document.getElementsByName('ammo')[0].value);
	rtn.steel   = parseInt(document.getElementsByName('steel')[0].value);
	rtn.bauxite = parseInt(document.getElementsByName('bauxite')[0].value);

	return rtn;
}

// args :: void
// return .self :: function
// description 原料のテーブルをクリアする関数
function clearMatsTable(){
	mats = new Object();
	
	mats.fuel    = 0;
	mats.ammo    = 0;
	mats.steel   = 0;
	mats.bauxite = 0;

	setMaterials(mats);
}

// args @start :: Date | Int(ms)
//      @end :: Date | Int(ms)
// return :: Int
// description startからendまでの経過時間を秒で返す
function TimeElapsedSec(start,end){
	return (end - start)/1000;
}

// args @sec :: Int
// return :: Object[fuel,ammo,steel,bauxite]
// description sec秒の間に資材がいくら自然回復するかを返す
function calcMaterials(sec){
	min = sec/60;
	unit = Math.floor(min/3);

	rtn = new Object();
	rtn.fuel   = unit*3;
	rtn.ammo   = unit*3;
	rtn.steel  = unit*3
	rtn.bauxite = unit;

	return rtn;
}
// args :: void
// return .self :: function
// description ユーザの入力に基づき計算を行う関数
function calculate(){
	mats = getMaterials();

	start = getInputTime('start')
	end   = getInputTime('end');
	start.setSeconds(0);
	elapsed = TimeElapsedSec(start,end);

	if(elapsed < 0){
		alert('予定時刻が開始時刻よりも前です。予定時刻は開始時刻より後でなければいけません。');
		return false;
	}
	
	calcmats = calcMaterials(elapsed);
	mats.fuel    += calcmats.fuel;
	mats.ammo    += calcmats.ammo;
	mats.steel   += calcmats.steel;
	mats.bauxite += calcmats.bauxite;

	setMaterials(mats);
}

// args :: void
// return .self :: function
// description 最初に実行する関数
function onloadFunc(){
	showNowTime();
	clockTimer();
	
	setInputTimeNow('start');
	setInputTimeNow('end');
	
	clearMatsTable();
}

-->
</script>

</head>

<body onload="onloadFunc()">
<h1>艦これ自然回復＆遠征資源計算機</h1>
<p>あなたが資源を使っていない間に、また遠征を出すとどれだけの資源が自然回復するかを計算します。<br>
資材に現在の値を入力し、時刻を設定し、計算ボタンを押すとどれだけ資材が自然回復するかがわかります。</p>
<p id="timenow">現在時刻：</p>
<form name="input">
<select name="calctype" size="2">
	<option value="settime" label="予定時刻で計算" selected>予定時刻で計算</option>
	<option value="elapsed" label="経過時間で計算">経過時間で計算</option>
</select>
<br>
開始時刻:
<input name="starttime" type="datetime-local">
予定時刻:
<input name="endtime" type="datetime-local">
<br>
<input name="elapsed" type="time" disabled style="display:none;">
<input type="button" value="計算" onclick="calculate()">
<input type="reset"  value="リセット">
<input type="button" value="開始時刻に現在時刻を入れる" onclick="setInputTimeNow('start')">
<input type="button" value="予定時刻に現在時刻を入れる" onclick="setInputTimeNow('end')">
</form>
<hr>
<table border="1">
	<tr>
		<th>燃料</th>
		<th>弾薬</th>
		<th>鋼材</th>
		<th>ボーキサイト</th>
	</tr>
	<tr>
		<td><form><input name="fuel" type="number"></form></td>
		<td><form><input name="ammo" type="number"></form></td>
		<td><form><input name="steel" type="number"></form></td>
		<td><form><input name="bauxite" type="number"></form></td>
	</tr>
</table>
<form>
	<input type="button" value="資材値を設定" onclick="setMatsData">
	<input type="button" value="表をクリア" onclick="clearMatsTable()">
</form>
</body>
</html>
